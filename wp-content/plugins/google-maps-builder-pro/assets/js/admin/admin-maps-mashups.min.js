var gmb_mashup;!function($,gmb){"use strict";var app={},title,address,lat,lng,info_bubble,load_log,ajax_spinner,featured_img,markers=[];return app.cache=function(){app.$body=$("body")},app.init=function(){app.cache(),app.$body.on("change",".gmb-mashup-post-type-field select",app.toggle_mashup_taxonomies),app.$body.on("change",".cmb-type-select-taxonomies select",app.toggle_mashup_terms),app.$body.on("click",".gmb-load-mashup",app.toggle_mashup_loading),app.$body.on("click",".gmb-set-mashup-marker",app.set_mashup_marker_icon),app.$body.on("change, click","#gmb_mashup_group_repeat .cmb-repeatable-grouping select, #gmb_mashup_group_repeat .cmb-repeatable-grouping input:not(hidden), #gmb_mashup_group_repeat .cmb-repeatable-grouping .cmb-multicheck-toggle",function(){$(this).parents(".cmb-repeatable-grouping").find(".gmb-load-mashup").addClass("button-primary").removeAttr("disabled").text(gmb_mashup.i18n.load_markers)}),$(window).on("load",function(){google.maps.event.addListenerOnce(map,"idle",app.load_configured_mashups)}),app.$body.find("#gmb_mashup_group_repeat").on("cmb2_add_row",app.configure_new_mashup_group)},app.configure_new_mashup_group=function(){var a=$("#gmb_mashup_group_repeat").find(".cmb-repeatable-grouping").last();a.find(".gmb-load-mashup").removeAttr("disabled").addClass("button-primary").text(gmb_mashup.i18n.load_markers),a.find(".gmb-mashup-post-type-field select").trigger("change")},app.load_configured_mashups=function(){info_bubble=new google.maps.InfoWindow({maxWidth:315}),$("#gmb_mashup_group_repeat").find(".cmb-repeatable-grouping").each(function(a,e){var r=$(this).find("#mashup_configured").val();if(ajax_spinner=$(this).find(".gmb-mashups-loading"),"true"==r){var t=$(this).data("iterator"),o=app.setup_marker_ajax_request(t);app.load_mashup(o)}})},app.setup_marker_ajax_request=function(a){var e=$("#gmb_mashup_group_"+a+"_post_type").val(),r=$("#gmb_mashup_group_"+a+"_taxonomy").val(),t=$("#gmb_mashup_group_"+a+"_latitude").val(),o=$("#gmb_mashup_group_"+a+"_longitude").val(),m=[];return $("input[id^=gmb_mashup_group_"+a+"_terms]:checked").each(function(a){m[a]=$(this).val()}),{action:"get_mashup_markers",post_type:e,taxonomy:r,terms:m,index:a,lat_field:t,lng_field:o}},app.toggle_mashup_taxonomies=function(){var a=$(this),e=a.val(),r=a.parents(".cmb-repeatable-grouping").data("iterator"),t=$(this).parents(".gmb-mashup-post-type-field").next(".gmb-taxonomy-select-field"),o=t.find("select"),m=a.parents(".cmb-repeatable-grouping").find(".gmb-terms-multicheck-field"),i=a.parents(".cmb-repeatable-grouping").find(".cmb-type-select-custom-meta"),p=a.parents(".cmb-repeatable-grouping").find(".mashup-load-status ol");t.hide(),m.hide(),i.hide(),p.empty();var n={action:"get_post_types_taxonomies",post_type:e,index:r};jQuery.post(ajaxurl,n,function(a){var e=jQuery.parseJSON(a);o.empty().html(e.taxonomy_options),t.show(),i.show(),i.find("select").empty().html(e.meta_key_options),$("#gmb_mashup_group_"+r+"_latitude").val("_gmb_lat"),$("#gmb_mashup_group_"+r+"_longitude").val("_gmb_lng"),"none"!==e.status&&(m.find(".cmb2-checkbox-list").empty().html(e.terms_checklist),m.show())})},app.toggle_mashup_terms=function(){var a=$(this),e=a.val(),r=a.parents(".cmb-repeatable-grouping").data("iterator"),t=$(this).parents(".cmb-repeatable-grouping").find(".gmb-terms-multicheck-field");if(t.hide(),"none"===e)return!1;var o={action:"get_taxonomy_terms",taxonomy:e,index:r};jQuery.post(ajaxurl,o,function(a){"none"!==a.status?t.find(".cmb-td").empty().html(a.terms_checklist):t.find(".cmb-td").empty().html(a.terms_checklist),t.show()},"json")},app.toggle_mashup_loading=function(a){a.preventDefault();var e=$(this),r=e.parents(".cmb-repeatable-grouping").data("iterator");ajax_spinner=e.parents(".cmb-repeatable-grouping").find(".gmb-mashups-loading"),ajax_spinner.show();var t=app.setup_marker_ajax_request(r);app.clear_mashup_markers(t.index),app.load_mashup(t)},app.load_mashup=function(a){jQuery.post(ajaxurl,a,function(e){var r=$('.cmb-repeatable-grouping[data-iterator="'+a.index+'"]').find(".cmb-type-mashups-load-panel");return load_log=r.find(".mashup-load-status > ol"),load_log.empty(),"undefined"!=typeof e.error?(load_log.html('<li class="gmb-error">'+e.error+"</li>"),ajax_spinner.hide(),!1):(app.clear_mashup_markers(a.index),markers[a.index]=[],featured_img=$("#gmb_mashup_group_"+a.index+"_featured_img1").prop("checked"),$.each(e,function(e,r){app.set_mashup_marker(a.index,r)}),r.find("#mashup_configured").val(!0),r.find("button").removeClass("button-primary").attr("disabled","disabled").text(gmb_mashup.i18n.mashup_configured),void ajax_spinner.hide())},"json")},app.set_mashup_marker=function(mashup_index,marker_data,loop_index){title="undefined"!=typeof marker_data.title?marker_data.title:"",address="undefined"!=typeof marker_data.address?marker_data.address:"",lat="undefined"!=typeof marker_data.latitude?marker_data.latitude:"",lng="undefined"!=typeof marker_data.longitude?marker_data.longitude:"";var marker_position=new google.maps.LatLng(lat,lng);if(!lat||!lng){var error='<li class="gmb-marker-status gmb-error"><strong>Marker Error:</strong> '+title+" - No latitude or longitude values found for this post.</li>";return void load_log.html(load_log.html()+error)}if("string"!=typeof lat||"string"!=typeof lng)return error='<li class="gmb-marker-status gmb-error"><strong>Marker Error:</strong> '+title+" - Improperly formatted latitude or longitude field data detected.</li>",void load_log.html(load_log.html()+error);var marker_icon=gmb_data.default_marker,marker_label="",custom_marker_icon=$("#gmb_mashup_group_"+mashup_index+"_marker").val(),custom_marker_img=$("#gmb_mashup_group_"+mashup_index+"_marker_img").val(),included_marker_img=$("#gmb_mashup_group_"+mashup_index+"_marker_included_img").val();if(included_marker_img)marker_icon=gmb_data.plugin_url+included_marker_img;else if(custom_marker_img)marker_icon=custom_marker_img;else if(custom_marker_icon.length>0&&custom_marker_icon.length>0){var custom_label=$("#gmb_mashup_group_"+mashup_index+"_label").val();marker_icon=eval("("+custom_marker_icon+")"),marker_label=custom_label}var featured_img=marker_data.featured_img=$("#gmb_mashup_group_"+mashup_index+"_featured_img1").is(":checked"),marker=new Marker({map:window.map,position:marker_position,marker_data:marker_data,featured_img:featured_img,icon:marker_icon,custom_label:marker_label});if(marker){var status='<li class="gmb-marker-status gmb-loaded"><strong>Marker Loaded:</strong> '+title+" - Lat: "+lat+" Lng: "+lng+"</liv>";load_log.html(load_log.html()+status)}google.maps.event.addListener(marker,"click",function(){app.get_infowindow_content(marker)}),markers[mashup_index].push(marker)},app.get_infowindow_content=function(a){info_bubble.setContent('<div id="infobubble-content" class="loading"></div>'),info_bubble.open(map,a);var e={action:"get_mashup_marker_infowindow",marker_data:a.marker_data,featured_img:a.featured_img};jQuery.post(ajaxurl,e,function(a){info_bubble.setContent(a.infowindow)},"json")},app.clear_mashup_markers=function(a){if("undefined"!=typeof markers[a])for(var e=0;e<markers[a].length;e++)markers[a][e].setMap(null)},app.set_mashup_marker_icon=function(){var a=$(this).parents(".cmb-repeatable-grouping").data("iterator");return $("body").find(".save-marker-button").attr("data-marker-index",a).on("click",function(e){e.preventDefault();var r,t=$(this).data("marker"),o=$(this).data("marker-color"),m=$(this).data("label-color"),i="color:"+m+"; ";"MAP_PIN"===t?i+="font-size: 20px;position: relative; top: -3px;":"SQUARE_PIN"==t&&(i+="font-size: 20px;position: relative; top: 12px;");var p='<i class="'+$(this).data("label")+'" style="'+i+'"></i>';if($("#gmb_mashup_group_"+a+"_marker").val(""),$("#gmb_mashup_group_"+a+"_label").val(""),$("#gmb_mashup_group_"+a+"_marker_img").val(""),$("#gmb_mashup_group_"+a+"_marker_included_img").val(""),"mapicons"==t||"upload"==t||"default"==t)if(r=$(this).data("marker-image"),"upload"==t)$("#gmb_mashup_group_"+a+"_marker_img").val(r);else{var n=r.replace(gmb_data.plugin_url,"");$("#gmb_mashup_group_"+a+"_marker_included_img").val(n)}else"MAP_PIN"!=t&&"SQUARE_PIN"!=t||(r="{ path : "+t+', fillColor : "'+o+'", fillOpacity : 1, strokeColor : "", strokeWeight: 0, scale : 1 / 3 }',$("#gmb_mashup_group_"+a+"_marker").val(r),$("#gmb_mashup_group_"+a+"_label").val(p));app.clear_mashup_markers(a);var s=app.setup_marker_ajax_request(a);app.load_mashup(s),$(".icon, .marker-item").removeClass("marker-item-selected"),$(".marker-icon-row, .save-marker-icon").hide(),$(this).removeData("marker"),$(this).removeData("marker-color"),$(this).removeData("marker-img"),$(this).removeData("label"),$(this).removeData("label-color"),0===$(".magnific-builder").length?$.magnificPopup.close():$(".gmb-modal-close").trigger("click")}),!1},$(document).ready(app.init),gmb.GMB_Mashups=app,app}(jQuery,window.MapsBuilderAdmin||(window.MapsBuilderAdmin={}));